name: Build and Push Container Image

on:
  push:
    branches: [main]
    paths:
      - 'Dockerfile'
      - 'start-openclaw.sh'
      - 'skills/**'
  workflow_dispatch: # Allow manual trigger

jobs:
  build-push:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies and build
        run: npm ci && npm run build

      - name: Configure wrangler OAuth
        env:
          WRANGLER_REFRESH_TOKEN: ${{ secrets.WRANGLER_REFRESH_TOKEN }}
        run: |
          mkdir -p ~/.config/.wrangler/config
          printf 'oauth_token = "expired"\nexpiration_time = "2000-01-01T00:00:00.000Z"\nrefresh_token = "%s"\nscopes = ["account:read", "user:read", "workers:write", "workers_kv:write", "workers_routes:write", "workers_scripts:write", "workers_tail:read", "d1:write", "pages:write", "zone:read", "ssl_certs:write", "ai:write", "ai-search:write", "ai-search:run", "queues:write", "pipelines:write", "secrets_store:write", "containers:write", "cloudchamber:write", "connectivity:admin", "offline_access"]\n' "$WRANGLER_REFRESH_TOKEN" > ~/.config/.wrangler/config/default.toml
          # Verify wrangler can authenticate
          npx wrangler whoami

      - name: Configure Docker registry auth
        run: |
          # Login to CF container registry using wrangler's credentials
          npx wrangler containers registry configure 2>&1 || true

      - name: Deploy to Cloudflare
        run: npx wrangler deploy
